<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=v8lvo8q53i&amp;submodules=geocoder"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.3.min.js"
      integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div style="margin-top: 20px; margin-bottom: 10px; font-weight: bold">
      ì•½êµ­ ì§€ë„
    </div>
    <div id="map" style="width: 100%; height: 500px"></div>
  </body>
  <script>
    $(document).ready(async () => {
      let XY = await getLocation();
      // alert("ìœ„ë„" + XY.lat);
      // alert("ê²½ë„" + XY.lng);
      await naver.maps.Service.reverseGeocode(
        {
          location: new naver.maps.LatLng(XY.lat, XY.lng),
        },
        function (status, response) {
          let result = response.result;
          let items = result.items;
          //console.log(items[0].addrdetail.sido); //ì‹œë„ì˜ ê°’
          //console.log(items[0].addrdetail.sigugun); //ì‹œêµ¬êµ°ì˜ ê°’
          let sido_arr = items[0].addrdetail.sido.split(" ");
          let gubun_arr = items[0].addrdetail.sigugun.split(" ");

          let sido = "";
          let gubun = "";
          if (sido_arr.length === 1) {
            sido = sido_arr[0];
            gugun = gubun_arr[0];
          } else if (sido_arr.length > 1) {
            sido = sido_arr[0];
            gugun = sido_arr[1];
          }
          // console.log(sido);
          // console.log(gugun);

          $.ajax({
            url: "/pharmach_list",
            type: "get", //index.jsì—ì„œ app.getìœ¼ë¡œ getì„ ì‚¬ìš©í•  ê²ƒì´ë¼ê³  ì„ ì–¸ì„ í–ˆê¸°ë•Œë¬¸ì— get
            cache: "false",
            dataType: "json",
            data: {
              Q0: sido,
              Q1: gugun,
              QT: "",
              QN: "",
              ORD: "",
              pageNo: "1",
              numOfRows: "1000",
            }, //ì² ì(ëŒ€,ì†Œë¬¸ìêµ¬ë¶„) í‹€ë¦¬ì§€ì•Šê²Œ ì¡°ì‹¬
            success: function (data) {
              console.log(data);
              //ì§€ë„ë¥¼ ì‚½ì…í•  HTML ìš”ì†Œ ë˜ëŠ” HTML ìš”ì†Œì˜ idë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
              let mapDiv = document.getElementById("map"); // 'map'ìœ¼ë¡œ ì„ ì–¸í•´ë„ ë™ì¼
              let mapOptions = {
                center: new naver.maps.LatLng(XY.lat, XY.lng), //ì˜µì…˜ìœ¼ë¡œ ë°›ì•„ì˜¨ í˜„ì¬ìœ„ì¹˜ì˜ ìœ„ë„ì™€ ê²½ë„ë¥¼ ë„£ì–´ì¤€ë‹¤.
                zoom: 14,
              };
              let map = new naver.maps.Map(mapDiv, mapOptions);

              data.items.item.forEach((it, index) => {
                let dutyName = it.dutyName; //ì•½êµ­ëª…
                let dutyAddr = it.dutyAddr; //ì£¼ì†Œ
                let dutyTel1 = it.dutyTel1; //ì „í™”ë²ˆí˜¸

                let dutyTime = ""; //ìš´ì˜ì‹œê°„
                if (it.dutyTime1s && it.dutyTime1c) {
                  dutyTime += `ì›”ìš”ì¼: ${it.dutyTime1s} ~ ${it.dutyTime1c} </br>`;
                }
                if (it.dutyTime2s && it.dutyTime2c) {
                  dutyTime += `í™”ìš”ì¼: ${it.dutyTime2s} ~ ${it.dutyTime2c} </br>`;
                }
                if (it.dutyTime3s && it.dutyTime3c) {
                  dutyTime += `ìˆ˜ìš”ì¼: ${it.dutyTime3s} ~ ${it.dutyTime3c} </br>`;
                }
                if (it.dutyTime4s && it.dutyTime4c) {
                  dutyTime += `ëª©ìš”ì¼: ${it.dutyTime4s} ~ ${it.dutyTime4c} </br>`;
                }
                if (it.dutyTime5s && it.dutyTime5c) {
                  dutyTime += `ê¸ˆìš”ì¼: ${it.dutyTime5s} ~ ${it.dutyTime5c} </br>`;
                }
                if (it.dutyTime6s && it.dutyTime6c) {
                  dutyTime += `í† ìš”ì¼: ${it.dutyTime6s} ~ ${it.dutyTime6c} </br>`;
                }
                if (it.dutyTime7s && it.dutyTime7c) {
                  dutyTime += `ì¼ìš”ì¼: ${it.dutyTime7s} ~ ${it.dutyTime7c} </br>`;
                }
                if (it.dutyTime8s && it.dutyTime8c) {
                  dutyTime += `ê³µíœ´ì¼: ${it.dutyTime8s} ~ ${it.dutyTime8c} </br>`;
                }

                let pharmacy_location = new naver.maps.LatLng(
                  it.wgs84Lat,
                  it.wgs84Lon
                );

                let marker = new naver.maps.Marker({
                  map: map,
                  position: pharmacy_location,
                });

                let contentString = [
                  '<div class="iw_inner">',
                  "   <h3>" + dutyName + "</h3>",
                  "   <p>" + dutyAddr + "<br />",
                  "       " + dutyTel1 + "<br />",
                  "      " + dutyTime,
                  "   </p>",
                  "</div>",
                ].join("");

                let infowindow = new naver.maps.InfoWindow({
                  content: contentString,
                  maxWidth: 440,
                  backgroundColor: "#eee",
                  borderColor: "#2db400",
                  borderWidth: 5,
                  anchorSize: new naver.maps.Size(30, 30),
                  anchorSkew: true,
                  anchorColor: "#eee",
                  pixelOffset: new naver.maps.Point(20, -20),
                });

                naver.maps.Event.addListener(marker, "click", function (e) {
                  if (infowindow.getMap()) {
                    infowindow.close();
                  } else {
                    infowindow.open(map, marker);
                  }
                });
              });
            },
            error: function (request, status, error) {},
          });
        }
      );
    });

    async function getLocation() {
      //asyncë¥¼ í†µí•´ getLocation í•¨ìˆ˜ì•ˆì— ë¹„ë™ê¸° êµ¬ë¬¸ì´ ìˆë‹¤ê³  í‘œì‹œí•´ì¤€ë‹¤.
      let XY = new Object(); //ê°ì²´ í˜•íƒœë¡œ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•œë‹¤.
      if (navigator.geolocation) {
        //ì•„ë˜ promiseë¥¼ í†µí•´ ë¹„ë™ê¸°ë¥¼ ë™ê¸°ë¡œ ë°”ê¿”ì¤€ë‹¤.
        let promise = new Promise((resolve, rejected) => {
          //promise ë³€ìˆ˜ëŠ” getCurrentPositionì„ ê°€ë¦¬í‚¨ë‹¤.
          navigator.geolocation.getCurrentPosition((position) => {
            resolve(position); //ì„±ê³µí•˜ì˜€ì„ ë•Œ positionê°ì²´ë¥¼ ë°˜í™˜í•´ì„œ position ê°’ì´ ì„±ê³µí•˜ê³ ë‚œ ë‹¤ìŒì— ë°˜í™˜ëœë‹¤.
          });
        });

        let position = await promise; // awaitë¥¼ í†µí•´ getCurrentPositionì´ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì¤€ë‹¤. ëë‚˜ê³ ë‚˜ë©´ positionë³€ìˆ˜ì— ê·¸ ê°’ì´ ë“¤ì–´ì™€ì„œ ë™ê¸°í˜•íƒœë¥¼ ëˆë‹¤.
        // navigator.geolocation.getCurrentPosition((position) => { ğŸ‘‹ë™ê¸°í˜•íƒœë¡œ ë°”ê¿¨ê¸° ë•Œë¬¸ì— ì—†ì• ë„ ëœë‹¤.
        //getCurrentPosition()ì€ ë¹„ë™ê¸°ì´ê¸° ë•Œë¬¸ì— ì•„ë˜ í”„ë¡œì„¸ìŠ¤ê°€ ì§„í–‰ë˜ëŠ” ë„ì¤‘ì— ë¦¬í„´ê°’ì´ ë°˜í™˜ë˜ì–´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ë™ê¸°í˜•ì‹ìœ¼ë¡œ ë°”ê¾¼ë‹¤.
        //í˜„ì¬ì˜ ìœ„ì¹˜ë¥¼ gpsë¡œ ì•Œì•„ë‚¸ë‹¤.
        position.coords.latitude; //ìœ„ë„
        position.coords.longitude; //ê²½ë„
        XY.lat = position.coords.latitude; //XY.lat ë³€ìˆ˜ì—ëŠ” ìœ„ë„ê°’ ì €ì¥
        XY.lng = position.coords.longitude; //XY.lng ë³€ìˆ˜ì—ëŠ” ê²½ë„ê°’ ì €ì¥
      }
      return XY;
    }
  </script>
</html>
